<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1">
    <title>iOS shim for HTML5 Drag and drop</title>
    <link rel="stylesheet" href="demo.css">
    <script src="demo.js"></script>
    <link rel="stylesheet" href="mobile-drag-and-drop-polyfill.css">
    <link rel="stylesheet" href="mobile-drag-and-drop-polyfill-icons.css">
    <script src="mobile-drag-and-drop-polyfill.js"></script>
</head>
<body>
<section id="wrapper">
    <header>
        <h1>iOS shim for HTML5 Drag and drop</h1>
    </header>
    <article>
        <p>Drag the list items over the dustbin, and drop them to have the bin eat the item</p>

        <div id="bin">
            <div id="innerBin"></div>
        </div>
        <ul>
            <li><a href="#" id="one"><span style="display: inline-block; background: lightblue">one</span></a></li>
            <li><a href="#" id="two">two</a></li>
            <li><a href="#" id="three">three</a></li>
            <li><a href="#" id="four">four</a></li>
            <li><a href="#" id="five">five</a></li>
            <li>
                <a href="#" id="six">six
                    <label>
                        nested select
                        <select>
                            <option>1</option>
                            <option>2</option>
                        </select>
                    </label>
                </a>
            </li>
            <li>
                <a id="seven">seven
                    <label>
                        nested input
                        <input type="text" />
                    </label>
                </a>
                <a id="nine">nine
                    <label>
                        nested input
                        <input type="radio" />
                    </label>
                </a>
                <a id="ten">ten
                    <label>
                        nested input
                        <input type="checkbox" />
                    </label>
                </a>
            </li>
            <li>
                <a href="#" id="eight">eight
                    <label>
                        nested textarea
                        <textarea>Blub</textarea>
                    </label>
                </a>
            </li>
        </ul>
        <hr/>
        <h4>box-sizing: border-box</h4>
        <ul class="border-boxed">
            <li><a href="#" id="eleven"><span style="display: inline-block; background: lightblue">eleven</span></a></li>
            <li><a href="#" id="twelve">twelve</a></li>
            <li><a href="#" id="thirteen">thirteen</a></li>
            <li><a href="#" id="fourteen">fourteen</a></li>
            <li><a href="#" id="fifteen">fifteen</a></li>
            <li></li>
        </ul>
        <hr/>
        <h4>flex-box children</h4>
        <ul class="flex-boxed">
            <li><a href="#"><span style="display: inline-block; background: lightblue">eleven</span></a></li>
            <li><a href="#">twelve</a></li>
            <li><a href="#">thirteen</a></li>
            <li><a href="#">fourteen</a></li>
            <li><a href="#">fifteen</a></li>
            <li>not explicitly draggable</li>
        </ul>
        <hr/>
        <h4>nested flex-box</h4>
        <ul class="flex-boxed dropzone">
            <ul draggable="true" class="dropzone">
                <li><h3>DRAGGABLE CONTAINER</h3></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
            </ul>
            <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
            <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
            <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
            <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
            <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
            <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
        </ul>
        <ul class="flex-boxed dropzone">
            <ul class="flex-boxed dropzone">
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
                <li class="flex-boxed"><div draggable="true">DRAG ME!</div></li>
            </ul>
            <li class="flex-boxed"><div>DRAG ME!</div></li>
            <li class="flex-boxed"><div>DRAG ME!</div></li>
            <li class="flex-boxed"><div>DRAG ME!</div></li>
            <li class="flex-boxed"><div>DRAG ME!</div></li>
            <li class="flex-boxed"><div>DRAG ME!</div></li>
            <li class="flex-boxed"><div>DRAG ME!</div></li>
        </ul>
        <hr/>
        <h4>Notes</h4>
        <ol>
            <li>The blue bordered item ('one') is a child inside a draggable element. If you drag the child, we should still drag the whole element.</li>
        </ol>
        <hr/>
        <div>
            <h3>New Elements</h3>
            <ul>
                <!-- The toolbox only allows to copy objects, not move it. After a new
                     element was created, dnd-copied is invoked and we generate the next id -->
                <li class="test" draggable="true">
                    <button type="button" class="btn btn-default btn-lg" disabled="disabled">some content</button>
                </li>
            </ul>
        </div>
    </article>
    <script>

        MobileDragAndDropPolyfill.Initialize({
            log: function () {

                var msg = "dnd-poly: ";
                for (var i = 0; i < arguments.length; i++) {
                    msg += arguments[i];
                }

                console.log(msg);
            },
            debug: true
        });

        /**
         * ---------------------------------------------------------------------------------------------------------
         */

        var missed = ['hey!', 'missed it :(', 'that was close..', 'ARRRR'];
        var eat = ['yum!', 'gulp', 'burp!', 'nom'];
        var yum = document.createElement('p');

        /**
         * ---------------------------------------------------------------------------------------------------------
         */

        var links = document.querySelectorAll('li > a'), el = null;
        for (var i = 0; i < links.length; i++) {
            el = links[i];

            el.setAttribute('draggable', 'true');

            addEvent(el, 'dragstart', function (e) {
                console.log('dragstart');

                e.dataTransfer.effectAllowed = 'copyLink';

                //TODO fails on desktop safari because drag is immediately aborted
//                this.style.display = "none";

                console.log('setting data: ' + this.id);

                e.dataTransfer.setData('Text', this.id); // required otherwise doesn't work
            });

            addEvent(el, 'drag', function (e) {
                console.log('drag');
            });

            addEvent(el, 'dragend', function (e) {

//                this.style.display = "block";

                console.log('dragend with effect: ' + e.dataTransfer.dropEffect);
            });

            addEvent(el, 'click', function (e) {
                console.log('clicked on draggable');

                console.log('click offsetX, offsetY: ' + e.offsetX + ", " + e.offsetY );
            });
        }

        /**
         * ---------------------------------------------------------------------------------------------------------
         */

        var bin = document.querySelector('#bin');

        addEvent(bin, 'dragenter', function (e) {
            console.log('bin dragenter');

            console.log('bin offsetX, offsetY: ' + e.offsetX + ", " + e.offsetY );

            e.preventDefault();
            e.stopPropagation(); // stop it here to prevent it bubble up

            bin.classList.add('over');

        });

        addEvent(bin, 'dragover', function (e) {
            console.log('bin dragover');

            console.log('bin offsetX, offsetY: ' + e.offsetX + ", " + e.offsetY );

            e.preventDefault(); // allows us to drop
            e.stopPropagation(); // stop it here to prevent it bubble up

            e.dataTransfer.dropEffect = 'link'; // we have to set it for firefox to be happy
        });

        addEvent(bin, 'dragexit', function (e) {
            console.log('bin dragexit');

            console.log('bin offsetX, offsetY: ' + e.offsetX + ", " + e.offsetY );

            e.stopPropagation(); // stop it here to prevent it bubble up
        });

        addEvent(bin, 'dragleave', function (e) {
            console.log('bin dragleave');

            console.log('bin offsetX, offsetY: ' + e.offsetX + ", " + e.offsetY );

            e.stopPropagation(); // stop it here to prevent it bubble up

            bin.classList.remove('over');
        });

        addEvent(bin, 'drop', function (e) {
            console.log('bin drop');

            console.log('bin offsetX, offsetY: ' + e.offsetX + ", " + e.offsetY );

            e.stopPropagation(); // stop it here to prevent it bubble up

            // stupid nom text + fade effect
            yum.innerHTML = missed[parseInt(Math.random() * missed.length)];

            var y = yum.cloneNode(true);
            bin.appendChild(y);

            setTimeout(function () {
                y.classList.add('fadeout');
            }, 250);
        });

        /**
         * ---------------------------------------------------------------------------------------------------------
         */

        var innerBin = document.querySelector('#innerBin');

        bin.classList.add('zoom');

        addEvent(innerBin, 'dragenter', function (e) {
            console.log('apperture dragenter');

            e.preventDefault();
            e.stopPropagation(); // stop it here to prevent it bubble up

            bin.classList.add('in');
        });

        addEvent(innerBin, 'dragover', function (e) {
            console.log('apperture dragover');

            e.preventDefault(); // allows us to drop
            e.stopPropagation(); // stop it here to prevent it bubble up

            e.dataTransfer.dropEffect = 'copy';
        });

        addEvent(innerBin, 'dragexit', function (e) {
            console.log('apperture dragexit');

            e.stopPropagation(); // stop it here to prevent it bubble up

            bin.classList.remove('in');
        });

        addEvent(innerBin, 'dragleave', function (e) {
            console.log('apperture dragleave');

            e.stopPropagation(); // stop it here to prevent it bubble up

            bin.classList.remove('in');
        });

        addEvent(innerBin, 'drop', function (e) {
            console.log('apperture drop');

            e.stopPropagation(); // stop it here to prevent it bubble up

            bin.classList.remove('in');

            var el = document.getElementById(e.dataTransfer.getData('Text'));

            el.parentNode.removeChild(el);

            // stupid nom text + fade effect
            yum.innerHTML = eat[parseInt(Math.random() * eat.length)];

            var y = yum.cloneNode(true);
            bin.appendChild(y);

            setTimeout(function () {
                y.classList.add('fadeout');
            }, 250);
        });


        /**
         * ---------------------------------------------------------------------------------------------------------
         */


        var flexboxedDraggables = document.querySelectorAll('ul > li.flex-boxed');
        for (var k = 0; k < flexboxedDraggables.length; k++) {
            var flexboxedDraggable = flexboxedDraggables[k];

            if(flexboxedDraggable.hasAttribute('draggable') === false) {
                console.log('setting flexboxed item draggable programmatically');

                flexboxedDraggable.setAttribute('draggable', 'true');
            }

            addEvent(flexboxedDraggable, 'dragstart', function (e) {
                console.log('dragstart');

                e.dataTransfer.effectAllowed = 'copyMove';
                e.dataTransfer.setData('Text', "Test"); // required otherwise doesn't work
            });

            addEvent(flexboxedDraggable, 'drag', function (e) {
                console.log('drag');
            });

            addEvent(flexboxedDraggable, 'dragend', function (e) {
                console.log('dragend with effect: ' + e.dataTransfer.dropEffect);
            });

            addEvent(el, 'click', function (e) {
                console.log('clicked on draggable');

                console.log('click offsetX, offsetY: ' + e.offsetX + ", " + e.offsetY );
            });
        }


        var flexboxedDropzones = document.querySelectorAll('.flex-boxed.dropzone');

        for (var j = 0; j < flexboxedDropzones.length; j++) {
            var flexboxedDropzone = flexboxedDropzones[j];

            addEvent(flexboxedDropzone, 'dragenter', function (e) {
                console.log('flexbox dropzone dragenter');

                e.preventDefault();
                e.stopPropagation(); // stop it here to prevent it bubble up
            });

            addEvent(flexboxedDropzone, 'dragover', function (e) {
                console.log('flexbox dropzone dragover');

                e.preventDefault(); // allows us to drop
                e.stopPropagation(); // stop it here to prevent it bubble up

                e.dataTransfer.dropEffect = 'copy';
            });

            addEvent(flexboxedDropzone, 'dragexit', function (e) {
                console.log('flexbox dropzone dragexit');

                e.stopPropagation(); // stop it here to prevent it bubble up
            });

            addEvent(flexboxedDropzone, 'dragleave', function (e) {
                console.log('flexbox dropzone dragleave');

                e.stopPropagation(); // stop it here to prevent it bubble up
            });

            addEvent(flexboxedDropzone, 'drop', function (e) {
                console.log('flexbox dropzone drop');

                e.stopPropagation(); // stop it here to prevent it bubble up
            });

        }

    </script>
    <footer>
        <a id="author" href="http://twitter.com/timruffles">@timruffles made this shim</a>/<a id="built" href="http://twitter.com/rem">original demo by
        @rem</a>/<a href="#view-source">source</a>
    </footer>
</section>

<a href="https://github.com/timruffles/ios-html5-drag-drop-shim">
    <img style="position: absolute; top: 0; left: 0; border: 0;"
         src="http://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"
         alt="Fork me on GitHub"/>
</a>

</body>
</html>


